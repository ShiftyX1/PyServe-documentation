---
slug: routing-and-extensions-devlog
title: Разработка расширяемой маршрутизации и системы extensions в PyServe
authors: [shifty]
tags: [devlog, routing, extensions, pyserve, architecture]
---

В этом техническом отчёте рассказываю о работе над ключевыми изменениями для PyServe 0.5.0: внедрением расширяемой маршрутизации и новой системы конфигурации через `extensions`.

<!--truncate-->

## Мотивация

PyServe изначально задумывался как простой, но гибкий сервер. С ростом проекта стало ясно: нужна система, позволяющая расширять функциональность без хака ядра и с поддержкой сложных сценариев маршрутизации (regex, SPA, приоритеты, fallback).

## Архитектура изменений

- **Секция `extensions` в конфиге** — теперь можно подключать расширения (например, для маршрутизации) декларативно.
- **RoutingExtension** — реализован модуль маршрутизации в стиле nginx:
  - Поддержка regex-паттернов, префиксов, точных совпадений
  - Приоритеты маршрутов
  - Захват параметров из URL
  - SPA fallback с исключениями
- **Обратная совместимость** — если у пользователя старый конфиг (v1), сервер работает по прежней схеме (`locations`, `reverse_proxy`).
- **Логирование** — все ключевые действия роутера и расширений теперь логируются.

## Пример новой конфигурации

```yaml
version: 2
extensions:
  - type: routing
    config:
      regex_locations:
        "~^/api/v(?P<version>\\d+)/":
          proxy_pass: "http://backend:3000"
        "=/health":
          return: "200 OK"
          content_type: "text/plain"
        "__default__":
          spa_fallback: true
          root: "./static"
          index_file: "index.html"
          exclude_patterns:
            - "/api/"
            - "/admin/"
```

## Как это работает

- При старте сервер определяет версию конфига и наличие расширений.
- Если есть routing extension — все запросы сначала проходят через него.
- Если нет или маршрут не найден — fallback на старую схему.
- SPA fallback позволяет отдавать index.html для всех несуществующих путей, кроме API и статических файлов.

## Итоги и планы

PyServe теперь готов к расширению через плагины и кастомные роутеры. Следующий шаг — публикация релиза 0.5.0, тестирование и написание подробной документации по созданию собственных extensions.

**PyServe — быстрый, расширяемый, современный.**

[GitHub проекта](https://github.com/ShiftyX1/PyServe)
