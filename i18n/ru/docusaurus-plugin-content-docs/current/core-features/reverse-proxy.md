---
sidebar_position: 4
---

# Обратный прокси

Узнайте, как настроить и использовать возможности обратного прокси PyServe для HTTP и WebSocket

## Обзор

Функция обратного прокси PyServe позволяет перенаправлять запросы на другие серверы. Она поддерживает протоколы HTTP и WebSocket, что делает ее идеальной для:

- Балансировки нагрузки
- Реализации API-шлюза
- Проксирования WebSocket
- Трансляции протоколов
- Терминации SSL/TLS

## Конфигурация

Настройки обратного прокси конфигурируются в разделе `reverse_proxy` файла `config.yaml`. Вы можете определить несколько правил прокси для разных путей.

```yaml
server:
  reverse_proxy:
    - host: localhost      # Хост бэкенд-сервера
      path: /api          # Путь для проксирования
      port: 3000         # Порт бэкенд-сервера
      ssl: false         # SSL/TLS бэкенда
      
    - host: localhost
      path: /ws
      port: 8080
      ssl: false         # SSL/TLS бэкенда
      
    - host: example.com
      path: /socket.io
      port: 443
      ssl: true          # Использовать SSL для соединения с бэкендом
```

:::info
**Поддержка WebSocket:** WebSocket-соединения автоматически определяются по заголовкам и не требуют специальной конфигурации. Все конфигурации прокси поддерживают протоколы HTTP и WebSocket.
:::

### Опции конфигурации

| Опция | Тип | Описание | По умолчанию |
|-------|-----|----------|--------------|
| `host` | string | Имя хоста или IP бэкенд-сервера | localhost |
| `path` | string | Префикс пути для проксирования | / |
| `port` | integer | Порт бэкенд-сервера | 80 |
| `ssl` | boolean | Использовать SSL/TLS для соединения с бэкендом | false |

:::info
**Примечание:** Параметр `websocket` был удален в пользу автоматического определения WebSocket через заголовки запроса.
:::

## HTTP проксирование

Для обычных HTTP-запросов прокси перенаправляет все заголовки, методы и содержимое тела на бэкенд-сервер. Ответ от бэкенда затем возвращается клиенту.

```yaml
# Пример конфигурации HTTP прокси
server:
  reverse_proxy:
    - host: api.internal
      path: /api
      port: 8000
      websocket: false
```

Эта конфигурация будет:
- Перенаправлять все запросы с `/api/*` на `http://api.internal:8000/*`
- Сохранять HTTP методы (GET, POST и т.д.)
- Перенаправлять заголовки запросов и тело
- Возвращать ответ бэкенда клиенту

## WebSocket проксирование

PyServe поддерживает WebSocket проксирование с автоматической обработкой обновления протокола и двунаправленной потоковой передачей данных.

```yaml
# Пример конфигурации WebSocket прокси
server:
  reverse_proxy:
    - host: ws.example.com
      path: /ws
      port: 8080
      websocket: true
      ssl: false
```

### Возможности WebSocket

- Автоматическая обработка обновления WebSocket
- Полная поддержка всех типов кадров WebSocket
- Поддержка бинарных и текстовых сообщений
- Обработка кадров Ping/Pong
- Чистое завершение соединения
- Поддержка SSL/TLS для безопасного WebSocket (WSS)

:::info
**Примечание:** При использовании WebSocket с SSL/TLS убедитесь, что и ваша SSL конфигурация PyServe, и настройки SSL бэкенда правильно настроены.
:::

## Конфигурация SSL/TLS

PyServe поддерживает SSL/TLS для соединений как с фронтендом, так и с бэкендом:

```yaml
# Фронтенд SSL (Клиент к PyServe)
ssl:
  enabled: true
  cert_file: ./ssl/cert.pem
  key_file: ./ssl/key.pem

# Бэкенд SSL (PyServe к бэкенду)
server:
  reverse_proxy:
    - host: secure.example.com
      path: /secure
      port: 443
      ssl: true      # Включить SSL для соединения с бэкендом
```

## Заголовки и перенаправление

PyServe автоматически обрабатывает и перенаправляет важные заголовки:

| Заголовок | Описание |
|-----------|----------|
| `X-Forwarded-For` | Оригинальный IP-адрес клиента |
| `X-Forwarded-Proto` | Оригинальный протокол (http/https) |
| `X-Forwarded-Host` | Оригинальный заголовок хоста |
| `Upgrade` | Для WebSocket соединений |
| `Connection` | Тип соединения |

## Примеры

### API-шлюз

```yaml
server:
  reverse_proxy:
    - host: auth.internal
      path: /auth
      port: 3000
    - host: api.internal
      path: /api/v1
      port: 8000
    - host: api.internal
      path: /api/v2
      port: 8001
```

### WebSocket чат-сервер

```yaml
server:
  reverse_proxy:
    - host: chat.internal
      path: /ws/chat
      port: 8080
      websocket: true
    - host: notifications.internal
      path: /ws/notifications
      port: 8081
      websocket: true
```

### Смешанный HTTP/WebSocket

```yaml
server:
  reverse_proxy:
    - host: api.example.com
      path: /api
      port: 443
      ssl: true
    - host: ws.example.com
      path: /realtime
      port: 443
      websocket: true
      ssl: true
```

## Лучшие практики

- Всегда используйте SSL/TLS для производственных развертываний
- Настройте соответствующие таймауты для WebSocket соединений
- Мониторьте производительность и ошибки прокси
- Используйте проверки состояния для бэкенд-серверов
- Реализуйте правильную обработку ошибок
- Рассмотрите ограничение скорости для API конечных точек

:::warning
**Примечание безопасности:** При проксировании внутренних сервисов убедитесь, что приняты соответствующие меры безопасности для предотвращения несанкционированного доступа.
:::

## Устранение неполадок

### Частые проблемы

| Проблема | Решение |
|----------|---------|
| WebSocket соединение не работает | Проверьте, установлен ли `websocket: true` и поддерживает ли бэкенд WebSocket |
| Ошибки SSL сертификата | Проверьте пути к SSL сертификатам и их действительность |
| Соединение отклонено | Проверьте конфигурацию хоста и порта бэкенд-сервера |
| Путь не найден | Проверьте конфигурацию пути прокси и маршруты бэкенда |