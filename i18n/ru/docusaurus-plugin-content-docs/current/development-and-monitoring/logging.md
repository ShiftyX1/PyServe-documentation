---
sidebar_position: 1
---

# Логирование

Узнайте, как настроить и использовать улучшенную систему логирования PyServe v0.4.2

## Обзор логирования

PyServe v0.4.2 включает полностью переработанную систему логирования с расширенными возможностями:

- Модульная архитектура логирования с отдельными форматтерами и обработчиками
- Цветной вывод в консоль для лучшей видимости
- Структурированное JSON-логирование для производственных сред
- Возможности ротации логов для управления размером файлов
- Настраиваемые уровни логирования и места назначения
- Оптимизированное по производительности логирование для асинхронных сред

:::info
**Новое в 0.3-async:** Полная переработка системы логирования с поддержкой структурированного логирования, ротации и расширенных опций форматирования.
:::

## Настройка логирования

Поведение логирования PyServe настраивается в разделе `logging` файла `config.yaml`:

```yaml
logging:
  level: INFO
  log_file: ./logs/pyserve.log
  console_output: true
  use_colors: true
  use_rotation: false
  max_log_size: 10485760  # 10 МБ
  backup_count: 5
  structured_logs: false
```

### Опции конфигурации

| Опция | Описание | По умолчанию |
|-------|----------|--------------|
| `level` | Уровень логирования (DEBUG, INFO, WARNING, ERROR, CRITICAL) | INFO |
| `log_file` | Путь к файлу лога | ./logs/pyserve.log |
| `console_output` | Выводить ли логи в консоль | true |
| `use_colors` | Включить цветной вывод в консоль | true |
| `use_rotation` | Включить ротацию логов | false |
| `max_log_size` | Максимальный размер файла лога (байты) | 10485760 (10 МБ) |
| `backup_count` | Количество резервных файлов логов | 5 |
| `structured_logs` | Включить структурированное JSON-логирование | false |

## Уровни логирования

Доступные уровни логирования, от наиболее к наименее подробным:

| Уровень | Случай использования | Цвет |
|---------|---------------------|------|
| `DEBUG` | Подробная информация, обычно полезная только для диагностики проблем | Голубой |
| `INFO` | Подтверждение того, что все работает как ожидалось | Зеленый |
| `WARNING` | Указание на то, что произошло что-то неожиданное | Желтый |
| `ERROR` | Из-за более серьезной проблемы программа не смогла выполнить некоторую функцию | Красный |
| `CRITICAL` | Серьезная ошибка, указывающая на то, что сама программа может не суметь продолжить работу | Жирный красный |

## Консольное логирование

Консольное логирование PyServe включает цветной вывод и пользовательское форматирование:

```
[PyServe] 2025-05-08 14:30:45 [INFO] Сервер запущен на http://127.0.0.1:8000/
[PyServe] 2025-05-08 14:30:45 [INFO] Директория статических файлов: /path/to/static
[PyServe] 2025-05-08 14:30:45 [INFO] Директория файлов шаблонов: /path/to/templates
[PyServe] 2025-05-08 14:30:52 [INFO] Клиент подключился с 127.0.0.1:54321
[PyServe] 2025-05-08 14:30:52 [INFO] [GET] | / с 127.0.0.1:54321
[PyServe] 2025-05-08 14:30:52 [INFO] User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64)
[PyServe] 2025-05-08 14:30:55 [DEBUG] Обслуживание статического файла: /path/to/static/css/styles.css (text/css)
[PyServe] 2025-05-08 14:31:02 [WARNING] Файл не найден: /path/to/static/nonexistent
```

### Пользовательские цвета консоли

Настройте цвета консоли, изменив конфигурацию форматтера:

```python
# Пример: Пользовательский цветной форматтер
from pyserve.core.logging import ColoredFormatter

formatter = ColoredFormatter()
formatter.LEVEL_COLORS['INFO'] = COLORS['BLUE']  # Изменить INFO на синий
```

## Файловое логирование

Файловые логи используют стандартный формат без цветов для лучшего анализа:

```
[2025-05-08 14:30:45] [INFO] Сервер запущен на http://127.0.0.1:8000/
[2025-05-08 14:30:45] [INFO] Директория статических файлов: /path/to/static
[2025-05-08 14:30:45] [INFO] Директория файлов шаблонов: /path/to/templates
[2025-05-08 14:30:52] [INFO] Клиент подключился с 127.0.0.1:54321
[2025-05-08 14:30:52] [INFO] [GET] | / с 127.0.0.1:54321
```

### Ротация логов

Включите ротацию логов, чтобы предотвратить чрезмерный рост файлов логов:

```yaml
logging:
  use_rotation: true
  max_log_size: 52428800  # 50 МБ
  backup_count: 10
```

Эта конфигурация будет:
- Создавать ротационные файлы логов (pyserve.log, pyserve.log.1, pyserve.log.2 и т.д.)
- Ротировать логи при достижении 50 МБ
- Хранить до 10 резервных файлов

## Структурированное логирование

PyServe 0.3-async представляет структурированное JSON-логирование для лучшего анализа логов:

```yaml
logging:
  structured_logs: true
```

Пример вывода структурированного лога:

```json
{
  "timestamp": "2025-05-08 14:30:45",
  "level": "INFO",
  "logger": "pyserve",
  "message": "Сервер запущен на http://127.0.0.1:8000/",
  "module": "http.server",
  "function": "start",
  "line": 156
}

{
  "timestamp": "2025-05-08 14:30:52",
  "level": "INFO",
  "logger": "pyserve",
  "message": "[GET] | / с 127.0.0.1:54321",
  "module": "http.server",
  "function": "handle_request",
  "line": 243,
  "request_id": "req_abc123",
  "client_ip": "127.0.0.1",
  "method": "GET",
  "path": "/",
  "user_agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64)"
}
```

:::tip
**Совет:** Структурированные логи идеально подходят для интеграции с инструментами анализа логов, такими как ELK Stack, Splunk или Grafana Loki.
:::

## Режим отладки

Включите режим отладки для более подробного логирования:

### Командная строка
```bash
python run.py -d
```

### Файл конфигурации
```yaml
logging:
  level: DEBUG
```

### Переменная окружения
```bash
export PYSERVE_LOG_LEVEL=DEBUG
python run.py
```

### Что логирует режим отладки

- Детали запроса/ответа
- Операции обслуживания статических файлов
- Процессы рендеринга шаблонов
- Операции обратного прокси
- Детали загрузки конфигурации
- Изменения внутреннего состояния сервера

## Использование логгера

При расширении PyServe или создании пользовательских обработчиков используйте логгер напрямую:

```python
from pyserve import get_logger

# Создание логгера с пользовательскими настройками
logger = get_logger(
    level=logging.DEBUG,
    log_file='./my-custom.log',
    use_rotation=True,
    structured_logs=True
)

# Использование логгера
logger.info("Приложение запущено")
logger.debug("Обработка запроса")
logger.warning("Получен необычный параметр")
logger.error("Не удалось подключиться к базе данных")
logger.critical("Сервер не может продолжить работу")

# Логирование исключений с трассировкой
try:
    risky_operation()
except Exception as e:
    logger.exception("Операция завершилась неудачей")
```

### Расширенная конфигурация логгера

```python
from pyserve.core.logging import PyServeLogger, FileHandler, ConsoleHandler

# Создание пользовательского логгера с несколькими обработчиками
logger = PyServeLogger(level=logging.DEBUG)

# Добавление пользовательского файлового обработчика
file_handler = FileHandler(
    'custom.log',
    level=logging.INFO,
    structured=True
)
logger.logger.addHandler(file_handler)

# Добавление пользовательского консольного обработчика
console_handler = ConsoleHandler(
    level=logging.DEBUG,
    use_colors=True
)
logger.logger.addHandler(console_handler)
```

## Примеры анализа логов

### Фильтрация логов по уровню
```bash
# Показать только ошибки и критические сообщения
grep -E '\[ERROR\]|\[CRITICAL\]' ./logs/pyserve.log

# Показать только логи запросов
grep '\[GET\]\|\[POST\]\|\[PUT\]\|\[DELETE\]' ./logs/pyserve.log
```

### Анализ структурированных логов с помощью jq
```bash
# Показать все логи уровня ERROR
jq 'select(.level == "ERROR")' ./logs/pyserve.log

# Показать логи для конкретного IP клиента
jq 'select(.client_ip == "192.168.1.100")' ./logs/pyserve.log

# Получить статистику запросов
jq -s 'group_by(.method) | map({method: .[0].method, count: length})' ./logs/pyserve.log
```

## Лучшие практики

### Разработка

- Используйте уровень DEBUG во время разработки
- Включите консольный вывод с цветами
- Включайте описательные сообщения логов с контекстом
- Логируйте как успешные операции, так и ошибки

### Производство

- Используйте уровень INFO или WARNING для уменьшения объема логов
- Включите файловое логирование с ротацией
- Рассмотрите структурированное логирование для инструментов анализа
- Отключите консольный вывод для лучшей производительности
- Реализуйте мониторинг оповещений для уровней ERROR и CRITICAL

### Производительность

- Более высокие уровни логирования (INFO, WARNING) имеют меньшее влияние, чем DEBUG
- Файловый ввод-вывод может стать узким местом при высокой нагрузке
- Рассмотрите асинхронное логирование для сценариев с высоким трафиком
- Используйте сервисы агрегации логов в производстве

## Пользовательские форматтеры логов

Создайте пользовательские форматтеры для конкретных нужд:

```python
from pyserve.core.logging import logging, COLORS

class CustomFormatter(logging.Formatter):
    def format(self, record):
        # Добавить ID запроса во все сообщения логов
        if hasattr(record, 'request_id'):
            record.msg = f"[{record.request_id}] {record.msg}"
            
        # Форматировать временную метку
        timestamp = self.formatTime(record, "%Y-%m-%d %H:%M:%S.%f")[:-3]
        
        # Пользовательский формат
        log_format = f"{timestamp} | {record.levelname:8} | {record.module:15} | {record.msg}"
        
        # Добавить цвет для консоли
        if hasattr(record, 'color'):
            log_format = f"{record.color}{log_format}{COLORS['RESET']}"
            
        return log_format
```

## Интеграция с внешними сервисами

### Syslog

Отправка логов на syslog-сервер:

```python
import logging.handlers

syslog_handler = logging.handlers.SysLogHandler(
    address=('localhost', 514),
    facility=logging.handlers.SysLogHandler.LOG_LOCAL0
)
logger.logger.addHandler(syslog_handler)
```

### Удаленное логирование

Отправка логов в удаленный сервис логирования:

```python
import logging.handlers

http_handler = logging.handlers.HTTPHandler(
    'logging.example.com',
    '/api/logs',
    method='POST'
)
logger.logger.addHandler(http_handler)
```

## Заключение

Система логирования PyServe 0.3-async предоставляет мощные инструменты для мониторинга и отладки вашего сервера:

- Гибкая конфигурация через YAML-файлы и переменные окружения
- Множественные уровни логирования для различных потребностей в детализации
- Цветной консольный вывод для разработки
- Структурированное JSON-логирование для производства
- Ротация логов для управления дисковым пространством
- Интеграция с внешними сервисами логирования

Правильно настроив и используя систему логирования, вы сможете легко отслеживать операции сервера, диагностировать проблемы и мониторить производительность как в среде разработки, так и в производственной среде.